@model VoteResultViewModel
@inject UserManager<DBApplicationUser> UserManager
@{
    ViewData["Title"] = "Results: " + ViewBag.VoteTitle;
    var totalVotes = Model.DBVoteItem.Count();
    var uniqueUsers = Model.DBVoteItem.Select(v => v.UserId).Distinct().Count();
}

<h2>Результати: @Model.Title</h2>

<div class="row">
    <div class="col-md-12">
        <div class="card mb-4">
            <div class="card-header">
                <h4>Підсумок голосування</h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <strong>Загальна кількість голосів:</strong> @uniqueUsers
                    </div>
                    <div class="col-md-3">
                        <strong>Дата початку:</strong> @Model.DBVote.StartDateTime.ToString("MMM dd, yyyy hh:mm:ss")
                    </div>
                    <div class="col-md-3">
                        <strong>Дата закінчення:</strong> @Model.DBVote.EndDateTime.ToString("MMM dd, yyyy hh:mm:ss")
                    </div>
                    <div class="col-md-3">
                        <strong>Статус:</strong>
                        <span class="badge @(DateTime.Now < Model.DBVote.EndDateTime ? "bg-success" : "bg-secondary")">
                            @(DateTime.Now < Model.DBVote.EndDateTime ? "Активне" : "Завершене")
                        </span>
                    </div>
                </div>
                @if (!string.IsNullOrEmpty(Model.DBVote.Description))
                {
                    <div class="mt-2">
                        <strong>Опис:</strong> @Model.DBVote.Description
                    </div>
                }
            </div>
        </div>
        @if (Model.DBVoteAlternative.Any())
        {
            <div class="card mb-4">
                <div class="card-header">
                    <h4>Огляд альтернатив</h4>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Альтернатива</th>
                                    <th>Середньозважений бал</th>
                                    <th>Кількість голосів</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var alternative in Model.DBVoteAlternative)
                                {
                                    var alternativeVotes = Model.DBVoteItem.Where(v => v.DBVoteAlternativeId == alternative.Id).ToList();
                                    var distinctUsers = alternativeVotes.Select(v => v.UserId).Distinct().Count();

                                    // Calculate weighted average score considering importance
                                    double weightedSum = 0;
                                    double totalWeight = 0;

                                    foreach (var vote in alternativeVotes)
                                    {
                                        // Get the criterion settings for this vote
                                        var criterionSettings = Model.DBVoteItemSettings.FirstOrDefault(s => s.Id == vote.DBVoteItemSettingsId);
                                        if (criterionSettings != null)
                                        {
                                            // Use the importance value from settings (default) or from user if overridden
                                            double importance = vote.ImportanceValue > 0 ? vote.ImportanceValue : criterionSettings.ImportanceValue;
                                            double normalizedImportance = importance / 100.0; // Convert to 0-1 scale

                                            weightedSum += vote.Value * normalizedImportance;
                                            totalWeight += normalizedImportance;
                                        }
                                    }

                                    var weightedAverageScore = totalWeight > 0 ? weightedSum / totalWeight : 0;

                                    <tr>
                                        <td>@alternative.Title</td>
                                        <td>
                                            <div class="progress">
                                                <div class="progress-bar" role="progressbar"
                                                     style="width: @Math.Ceiling((weightedAverageScore * 10))%"
                                                     aria-valuenow="@weightedAverageScore"
                                                     aria-valuemin="0"
                                                     aria-valuemax="10">
                                                    @weightedAverageScore.ToString("F2")
                                                </div>
                                            </div>
                                        </td>
                                        <td>@distinctUsers</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        }

        <!-- Detailed Results by Vote Item -->
        <div class="card mb-4">
            <div class="card-header">
                <h4>Детальні результати за критеріями</h4>
            </div>
            <div class="card-body">
                @foreach (var itemSetting in Model.DBVoteItemSettings)
                {
                    var itemVotes = Model.DBVoteItem.Where(v => v.DBVoteItemSettingsId == itemSetting.Id).ToList();
                    var averageValue = itemVotes.Any() ? itemVotes.Average(v => v.Value) : 0;
                    var minValue = itemVotes.Any() ? itemVotes.Min(v => v.Value) : 0;
                    var maxValue = itemVotes.Any() ? itemVotes.Max(v => v.Value) : 0;

                    <div class="vote-item mb-4 p-3 border rounded">
                        <h5>@itemSetting.Title</h5>
                        @if (!string.IsNullOrEmpty(itemSetting.Description))
                        {
                            <p class="text-muted">@itemSetting.Description</p>
                        }

                        <div class="row">
                            <div class="col-md-6">
                                <strong>Статистика:</strong>
                                <ul class="list-unstyled">
                                    <li>Середнє значення: <strong>@averageValue.ToString("F2")</strong></li>
                                    <li>Діапазон значень: @minValue.ToString("F2") - @maxValue.ToString("F2")</li>
                                    <li>Кількість голосів: @itemVotes.Count</li>
                                </ul>
                            </div>
                            @if (itemSetting.ImportanceValue != 100) 
                            {
                                <div class="col-md-6">
                                    <strong>Importance:</strong> @itemSetting.ImportanceValue
                                </div>
                            }
                        </div>

                        @if (Model.DBVoteAlternative.Any())
                        {
                            <div class="mt-3">
                                <strong>Розподіл за альтернативами:</strong>
                                <div class="table-responsive mt-2">
                                    <table class="table table-sm table-bordered">
                                        <thead>
                                            <tr>
                                                <th>Альтернатива</th>
                                                <th>Середнє значення</th>
                                                <th>Кількість голосів</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var alternative in Model.DBVoteAlternative)
                                            {
                                                var altVotes = itemVotes.Where(v => v.DBVoteAlternativeId == alternative.Id).ToList();
                                                var altAverage = altVotes.Any() ? altVotes.Average(v => v.Value) : 0;

                                                <tr>
                                                    <td>@alternative.Title</td>
                                                    <td>@altAverage.ToString("F2")</td>
                                                    <td>@altVotes.Count</td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        }
                        @if (totalVotes != 0)
                        {
                            <div class="mt-3">
                                <strong>Розподіл зачень:</strong>
                                <div class="distribution-chart mt-2">
                                    @{
                                        var valueGroups = itemVotes.GroupBy(v => Math.Round(v.Value, 1))
                                        .OrderBy(g => g.Key)
                                        .Select(g => new { Value = g.Key, Count = g.Count() })
                                        .ToList();
                                        var maxCount = valueGroups.Any() ? valueGroups.Max(g => g.Count) : 1;
                                    }
                                    @foreach (var group in valueGroups)
                                    {
                                        var percentage = (group.Count * 100) / Math.Max(maxCount, 1);
                                        <div class="d-flex align-items-center mb-1">
                                            <small class="text-muted" style="width: 40px;">@group.Value</small>
                                            <div class="progress flex-grow-1" style="height: 20px;">
                                                <div class="progress-bar bg-primary" role="progressbar"
                                                     style="width: @percentage%"
                                                     aria-valuenow="@group.Count"
                                                     aria-valuemin="0"
                                                     aria-valuemax="@maxCount">
                                                    @group.Count
                                                </div>
                                            </div>
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                }
            </div>
        </div>

        <!-- User Participation Summary -->
        @if (!Model.IsPrivate)
        {
            <div class="card">
                <div class="card-header">
                    <h4>Підсумки участі</h4>
                </div>
                <div class="card-body">
                    @{
                        var votesPerUser = Model.DBVoteItem.GroupBy(v => v.UserId)
                        .Select(g => new { UserId = g.Key, VoteCount = g.Count() })
                        .OrderByDescending(x => x.VoteCount)
                        .ToList();
                    }
                    <div class="row">
                        <div class="col-md-12">
                            <strong>Загальна кількість учасників:</strong> @Model.UserIDs.Count()
                        </div>
                        <div class="col-md-12">
                            <strong>Кількість учасників, які прийняли участь в опитуванні:</strong> @uniqueUsers
                        </div>
                    </div>
                        <div class="mt-3">
                        @if (votesPerUser.Any())
                        {
                            <strong>Учасники, які взяли участь в опитуванні:</strong>
                            <div class="table-responsive mt-2">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Ім'я</th>
                                            <th>Ім'я користувача</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var user in votesPerUser)
                                        {
                                            var u = UserManager.FindByIdAsync(user.UserId).Result;
                                            <tr>
                                                <td>@u.FirstName @u.LastName</td>
                                                <td>@u.UserName</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                            <strong>Усі учасники:</strong>
                            <div class="table-responsive mt-2">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Ім'я</th>
                                            <th>Ім'я користувача</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        
                                        @foreach (var id in Model.UserIDs)
                                        {
                                            var u = UserManager.FindByIdAsync(id).Result;
                                            <tr>
                                                <td>@u.FirstName @u.LastName</td>
                                                <td>@u.UserName</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>

                        </div>

                </div>
            </div>
            <!-- All Votes Table -->
<div class="card mb-4">
    <div class="card-header">
        <h4>Усі голоси</h4>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-bordered">
                <thead class="table-dark">
                    <tr>
                        <th>Користувач</th>
                        <th>Альтернатива</th>
                        <th>Критерій</th>
                        <th>Оцінка</th>
                        <th>Важливість</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var vote in Model.DBVoteItem.OrderBy(v => v.DBVoteAlternativeId).ThenBy(v => v.DBVoteItemSettingsId))
                    {
                        var user = await UserManager.FindByIdAsync(vote.UserId);
                        var alternative = Model.DBVoteAlternative.FirstOrDefault(a => a.Id == vote.DBVoteAlternativeId);
                        var itemSetting = Model.DBVoteItemSettings.FirstOrDefault(s => s.Id == vote.DBVoteItemSettingsId);
                        
                        <tr>
                            <td>
                                @if (user != null)
                                {
                                    <text>@user.FirstName @user.LastName (@user.UserName)</text>
                                }
                                else
                                {
                                    <text>Невідомий користувач</text>
                                }
                            </td>
                            <td>@(alternative?.Title ?? "Невідома альтернатива")</td>
                            <td>@(itemSetting?.Title ?? "Невідомий критерій")</td>
                            <td>
                                <span class="badge bg-primary">@vote.Value.ToString("F1")</span>
                            </td>
                            <td>
                                @{
                                    var importanceValue = vote.ImportanceValue > 0 ? vote.ImportanceValue : itemSetting?.ImportanceValue ?? 100;
                                }
                                <span class="badge bg-info">@importanceValue</span>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
        
        <!-- Summary statistics -->
        <div class="row mt-3">
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title">@Model.DBVoteItem.Count()</h5>
                        <p class="card-text">Всього голосів</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title">@Model.DBVoteItem.Select(v => v.UserId).Distinct().Count()</h5>
                        <p class="card-text">Унікальних користувачів</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title">@Model.DBVoteAlternative.Count()</h5>
                        <p class="card-text">Альтернатив</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title">@Model.DBVoteItemSettings.Count()</h5>
                        <p class="card-text">Критеріїв</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Alternative Votes Summary -->
<div class="card mb-4">
    <div class="card-header">
        <h4>Підсумок голосів за альтернативами</h4>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Альтернатива</th>
                        <th>Кількість голосів</th>
                        <th>Середній бал</th>
                        <th>Унікальні користувачі</th>
                        <th>Деталі</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var alternative in Model.DBVoteAlternative)
                    {
                        var alternativeVotes = Model.DBVoteItem.Where(v => v.DBVoteAlternativeId == alternative.Id).ToList();
                        var distinctUsers = alternativeVotes.Select(v => v.UserId).Distinct().Count();
                        var averageScore = alternativeVotes.Any() ? alternativeVotes.Average(v => v.Value) : 0;
                        
                        <tr>
                            <td><strong>@alternative.Title</strong></td>
                            <td>@alternativeVotes.Count</td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="progress flex-grow-1 me-2" style="height: 10px;">
                                        <div class="progress-bar bg-success" 
                                             style="width: @Math.Ceiling((averageScore * 10))%"
                                             title="@averageScore.ToString("F2")">
                                        </div>
                                    </div>
                                    <span>@averageScore.ToString("F2")</span>
                                </div>
                            </td>
                            <td>@distinctUsers</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" 
                                        type="button" 
                                        data-bs-toggle="collapse" 
                                        data-bs-target="#collapseAlternative@(alternative.Id)" 
                                        aria-expanded="false" 
                                        aria-controls="collapseAlternative@(alternative.Id)">
                                    Показати деталі
                                </button>
                            </td>
                        </tr>
                        <tr class="collapse-row">
                            <td colspan="5" class="p-0">
                                <div class="collapse" id="collapseAlternative@(alternative.Id)">
                                    <div class="p-3 bg-light">
                                        <h6>Детальні результати для: @alternative.Title</h6>
                                        <div class="table-responsive">
                                            <table class="table table-sm">
                                                <thead>
                                                    <tr>
                                                        <th>Критерій</th>
                                                        <th>Кількість голосів</th>
                                                        <th>Середній бал</th>
                                                        <th>Мін.</th>
                                                        <th>Макс.</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    @foreach (var itemSetting in Model.DBVoteItemSettings)
                                                    {
                                                        var criterionVotes = alternativeVotes.Where(v => v.DBVoteItemSettingsId == itemSetting.Id).ToList();
                                                        var criterionAvg = criterionVotes.Any() ? criterionVotes.Average(v => v.Value) : 0;
                                                        var criterionMin = criterionVotes.Any() ? criterionVotes.Min(v => v.Value) : 0;
                                                        var criterionMax = criterionVotes.Any() ? criterionVotes.Max(v => v.Value) : 0;
                                                        
                                                        <tr>
                                                            <td>@itemSetting.Title</td>
                                                            <td>@criterionVotes.Count</td>
                                                            <td>@criterionAvg.ToString("F2")</td>
                                                            <td>@criterionMin.ToString("F1")</td>
                                                            <td>@criterionMax.ToString("F1")</td>
                                                        </tr>
                                                    }
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>
        }
    </div>
</div>

<style>
    .vote-item {
        background-color: #f8f9fa;
        border-left: 4px solid #007bff !important;
    }

    .distribution-chart .progress {
        background-color: #e9ecef;
    }

    .badge {
        font-size: 0.75em;
    }

    .table th {
        border-top: none;
        font-weight: 600;
    }
</style>